#!/bin/bash

data_file="matrics.yml"
DB="https://{{ db_ip }}:{{ db_port }}/write"
server_UUID=$(curl  http://169.254.169.254/openstack/latest/meta_data.json -s  | grep -ioP .{8}-.{4}-.{4}-.{4}-.{12})
vm_info=$(openstack server show $server_UUID --os-cloud openstack)
flavor=$(echo $vm_info | grep -ioP "flavor\s\|\s\S*" | cut -c 10-)
image=$(echo $vm_info | grep -ioP "image\s\|\s\S*" | cut -c 9-)

run_benchmark () {
	echo -------------------------------------------------------
	echo Run GPU Benchmark
	echo -------------------------------------------------------

	./get-iris.sh
	./run_iris.sh
}

send_data () {
	curl -H "Authorization: Basic `echo -n "{{ db_username }}:{{ db_password }}" | base64`" -d 'gpu_benchmark,image='"$image"',flavor='"$flavor"',test_type='$benchmark' 'result'='"$bench_score"'' -X POST $DB --insecure
	curl -H "Authorization: Basic `echo -n "{{ db_username }}:{{ db_password }}" | base64`" -d 'gpu_benchmark,image='"$image"',flavor='"$flavor"',test_type='${benchmark} Emisions' 'result'='"$gpu_emisions_"'' -X POST $DB --insecure
}

read_data () {
	while IFS = read -r line; do
		benchmark=$(yq '.benchmark' data_file)
		bench_score=$(yq '.score' data_file)
		gpu_emisions=$(yq '.total_carbon' data_file)
	done < $data_file	
}

benchmark_and_send_data () {
	run_benchmark
	read_data
	send_data
}

# Get VM infor
server_UUID=$(curl  http://169.254.169.254/openstack/latest/meta_data.json -s  | grep -ioP .{8}-.{4}-.{4}-.{4}-.{12})
vm_info=$(openstack server show $server_UUID --os-cloud openstack)
hypervisor=$(echo $vm_info | grep -ioP "\w*.nubes.rl.ac.uk" | head -1)
flavor=$(echo $vm_info | grep -ioP "flavor\s\|\s\S*" | cut -c 10-)
image=$(echo $vm_info | grep -ioP "image\s\|\s\S*" | cut -c 9-)

DB="https://{{ db_ip }}:{{ db_port }}/write"

benchmark_and_send_data
